

<template>
    <div>
        <div class="panel presets">
            <Presets :data="$props.data.presets"></Presets>
        </div>

        <div class="panel">
            <div class="tabs">
                <ul>
                    <li v-for="tab in tabs" :class="tabClass(tab.key)">
                        <a @click="showTab(tab.key)">
                            {{ $t(tab.display) }}{{ changes(tab.key) }}
                            <i v-if="warnings(tab.key)" class="fas fa-exclamation-triangle"></i>
                        </a>
                    </li>
                </ul>
            </div>

            <component
                :is="tab"
                v-for="tab in tabs"
                :key="tab.key"
                :ref="tab.key"
                :data="$props.data[tab.key]"
                :style="{ display: active === tab.key ? undefined : 'none' }"
                class="container"
            ></component>

            <div class="navigation-buttons">
                <a v-if="previousTab !== false" class="button is-mini" @click="showPreviousTab">
                    <i class="fas fa-long-arrow-alt-left"></i> <span>{{ $t('common.back') }}</span>
                </a>
                <a v-if="nextTab !== false" class="button is-primary is-mini" @click="showNextTab">
                    <span>{{ $t('common.next') }}</span> <i class="fas fa-long-arrow-alt-right"></i>
                </a>
            </div>
        </div>
    </div>
</template>

<script>
    import analytics from '../util/analytics';
    import isChanged from '../util/is_changed';
    import Presets from './domain_sections/presets';
    import Sections from './domain_sections';

    const delegated = {
        hasUserInteraction: false,
        presets: Presets.delegated,
        ...Sections.reduce((prev, tab) => {
            prev[tab.key] = tab.delegated;
            return prev;
        }, {}),
    };

    export default {
        name: 'Domain',
        delegated,          // Data the parent will present here
        components: {
            Presets,
        },
        props: {
            data: Object,   // Data delegated back to us from parent
        },
        data() {
            return {
                active: Sections[0].key,
                tabs: Sections,
            };
        },
        computed: {
            nextTab() {
                const tabs = this.$data.tabs.map(t => t.key);
                const index = tabs.indexOf(this.$data.active) + 1;
                if (index < tabs.length) return tabs[index];
                return false;
            },
            previousTab() {
                const tabs = this.$data.tabs.map(t => t.key);
                const index = tabs.indexOf(this.$data.active) - 1;
                if (index >= 0) return tabs[index];
                return false;
            },
            hasWarnings() {
                return Object.values(this.$refs).some(ref => ref[0].hasWarnings || false);
            },
        },
        methods: {
            changesCount(tab) {
                return Object.keys(this.$props.data[tab])
                    .filter(key => isChanged(this.$props.data[tab][key], tab, key)).length;
            },
            changes(tab) {
                const changes = this.changesCount(tab);
                if (changes) return ` (${changes.toLocaleString()})`;
                return '';
            },
            warnings(tab) {
                if (!Object.prototype.hasOwnProperty.call(this.$refs, tab)) return false;
                return this.$refs[tab][0].hasWarnings || false;
            },
            setValue(tab, key, val) {
                Object.assign(this.$props.data[tab][key], { value: val, computed: val });
            },
            resetValue(tab, key) {
                this.setValue(tab, key, this.$props.data[tab][key].default);
            },
            tabClass(tab) {
                const classes = [];
                if (tab === this.$data.active) classes.push('is-active');
                if (this.changesCount(tab)) classes.push('is-changed');
                const tabs = this.$data.tabs.map(t => t.key);
                if (tabs.indexOf(tab) < tabs.indexOf(this.$data.active)) classes.push('is-before');
                return classes.join(' ');
            },
            showTab(target) {
                // Analytics
                analytics({
                    category: 'Site',
                    action: 'Tab clicked',
                    label: `${this.$data.active}, ${target}`,
                });

                // Go!
                this.$data.active = target;
            },
            showPreviousTab() {
                // Analytics
                analytics({
                    category: 'Site',
                    action: 'Back clicked',
                    label: `${this.$data.active}, ${this.previousTab}`,
                });

                // Go!
                this.$data.active = this.previousTab;
            },
            showNextTab() {
                // Analytics
                analytics({
                    category: 'Site',
                    action: 'Next clicked',
                    label: `${this.$data.active}, ${this.nextTab}`,
                });

                // Go!
                this.$data.active = this.nextTab;
            },
        },
    };
</script>
